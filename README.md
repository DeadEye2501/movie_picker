# Movie Picker

Десктопное приложение для поиска фильмов и сериалов с персонализированными рекомендациями на основе ваших оценок.

## Возможности

- **Поиск** — фильмов и сериалов по названию, актёрам, режиссёрам с фильтрацией по жанрам
- **Рейтинги** — отображение оценок TMDB, IMDB, Kinopoisk, Rotten Tomatoes и Metacritic
- **Персональные рекомендации** — система учитывает ваши оценки фильмов/сериалов и подбирает контент под ваш вкус
- **Волшебная кнопка** — мгновенно находит лучший непросмотренный фильм или сериал
- **Похожие фильмы** — поиск похожего контента на основе рекомендаций TMDB
- **Рецензии** — возможность писать заметки к просмотренным фильмам и сериалам
- **Тёмная тема** — Material Design интерфейс

## Установка

### Требования

- Python 3.13+
- pipenv

### Шаги

```bash
# Клонировать репозиторий
git clone <repository-url>
cd movie_picker

# Установить зависимости
pipenv install

# Создать .env с API ключами
cp .env.example .env
# Отредактировать .env и вставить свои ключи

# Запустить приложение
pipenv run python main.py
```

## Конфигурация

Создайте файл `.env` в корне проекта (или скопируйте из `.env.example`):

```env
MDBLIST_API_KEY=ваш_ключ_mdblist
TMDB_API_KEY=ваш_ключ_tmdb
OMDB_API_KEY=ваш_ключ_omdb
KINOPOISK_API_KEY=ваш_ключ_kinopoisk
```

### Получение API ключей

1. **TMDB** (обязательно):
   - Зарегистрируйтесь на [themoviedb.org](https://www.themoviedb.org/)
   - Перейдите в Settings → API → Create → Developer
   - Скопируйте API Key (v3 auth)

2. **MDBList** (настоятельно рекомендуется, основной источник рейтингов):
   - Зарегистрируйтесь на [mdblist.com](https://mdblist.com/)
   - После входа перейдите в Preferences
   - Скопируйте API Key
   - Бесплатно: 1000 запросов/день

3. **OMDB** (опционально, запасной источник рейтингов):
   - Получите бесплатный ключ на [omdbapi.com](https://www.omdbapi.com/apikey.aspx)
   - Используется, если MDBList недоступен
   - Бесплатно: 1000 запросов/день

4. **Kinopoisk** (опционально, для рейтингов Кинопоиска):
   - Получите ключ на [kinopoiskapiunofficial.tech](https://kinopoiskapiunofficial.tech/)
   - Требуется регистрация

## Использование

### Поиск фильмов и сериалов

1. Введите запрос в строку поиска (название, актёр, режиссёр)
2. Опционально выберите жанры (фильтр по AND — все выбранные жанры должны присутствовать)
3. Нажмите кнопку поиска

Поиск работает одновременно для фильмов и сериалов.

### Оценка контента

Кликните на звёзды (1-10) на карточке фильма или сериала. Цвет звёзд меняется от красного (1) до синего (10).

### Волшебная кнопка

Нажмите кнопку со звёздочками справа от поиска — система найдёт лучший непросмотренный фильм на основе ваших предпочтений.

### Похожий контент

На карточке фильма или сериала нажмите "Найти похожие" для поиска похожего контента.

## Как работает система рекомендаций

### Архитектура данных

Система использует нормализованную структуру базы данных:
- **Жанры, режиссёры и актёры** хранятся в отдельных таблицах (`Genre`, `Director`, `Actor`)
- Связь с фильмами через many-to-many таблицы (`MovieGenre`, `MovieDirector`, `MovieActor`)
- Каждая сущность хранит персональную статистику: `avg_rating` (средняя оценка) и `rating_count` (количество оценок)

При оценке фильма автоматически пересчитываются рейтинги всех связанных с ним жанров, режиссёров и актёров.

### Формула персонального рейтинга

Для каждого фильма вычисляется персональный score на основе ваших предпочтений:

```
score = 1.0 × TMDB_близость +
        0.8 × (рейтинг_режиссёра - 5) +
        0.5 × (средний_рейтинг_жанров - 5) +
        0.3 × (средний_рейтинг_актёров - 5) +
        0.2 × (рейтинг_агрегаторов - 5)
```

### TMDB близость

- Для каждого оценённого фильма/сериала (6-10 = понравился, 1-4 = не понравился) система получает рекомендации TMDB
- Если искомый контент есть в рекомендациях понравившегося — score увеличивается
- Если в рекомендациях не понравившегося — score уменьшается
- Позиция в списке рекомендаций влияет на вес (первые позиции важнее)

### Рейтинги сущностей

Каждая сущность (жанр/режиссёр/актёр) имеет персональный рейтинг:
- **Жанры** — среднее по всем оценённым фильмам этого жанра
- **Режиссёры** — среднее по всем оценённым фильмам режиссёра
- **Актёры** — среднее по всем оценённым фильмам с участием актёра (учитываются топ-5 актёров)

Эти рейтинги автоматически обновляются при каждой новой оценке.

### Оптимизации

- Рекомендации TMDB кэшируются в БД (таблица `RecommendationCache`)
- Параллельные API запросы для ускорения поиска
- Учитываются только топ-15 понравившихся и топ-15 не понравившихся фильмов для расчёта TMDB близости
- LRU кэш в памяти для горячих рекомендаций (до 200 записей)

## Структура проекта

```
movie_picker/
├── main.py                 # Точка входа
├── .env                    # API ключи (не в git)
├── .env.example            # Шаблон для .env
├── movie_picker.db         # SQLite база данных
│
├── api/
│   ├── __init__.py
│   ├── tmdb.py             # TMDB API клиент
│   ├── mdblist.py          # MDBList API клиент (рейтинги)
│   ├── omdb.py             # OMDB API клиент
│   └── kinopoisk.py        # Kinopoisk API клиент
│
├── database/
│   ├── __init__.py
│   ├── models.py           # SQLAlchemy модели (Movie, Genre, Director, Actor, etc.)
│   ├── db.py               # Операции с БД
│   └── genre_utils.py      # Утилиты для работы с жанрами
│
├── services/
│   ├── __init__.py
│   ├── search.py           # Сервис поиска
│   └── recommender.py      # Система рекомендаций
│
└── ui/
    ├── __init__.py
    ├── app.py              # Главное окно
    ├── theme.py            # Тёмная тема
    └── components/
        ├── __init__.py
        ├── search_bar.py   # Панель поиска
        ├── movie_list.py   # Список фильмов
        ├── movie_card.py   # Карточка фильма
        └── rating_dialog.py # Диалог рецензии
```

## Модели данных

### Movie
Основная таблица фильмов и сериалов:
- `kinopoisk_id` — TMDB ID (название устаревшее, но сохранено для обратной совместимости)
- `is_tv` — флаг типа контента (False = фильм, True = сериал)
- `imdb_id` — IMDB ID для получения рейтингов
- `title`, `title_original` — русское и оригинальное названия
- `year`, `description`, `poster_url`
- `tmdb_rating`, `kp_rating`, `imdb_rating`, `rotten_tomatoes`, `metacritic`
- Relationships:
  - `genre_list` — связь many-to-many с жанрами
  - `director_list` — связь many-to-many с режиссёрами
  - `actor_list` — связь many-to-many с актёрами
  - `user_rating` — связь one-to-one с пользовательской оценкой

### Genre
Справочник жанров с персональными рейтингами:
- `id` — уникальный идентификатор
- `name` — каноническое название (например, "боевик")
- `aliases` — альтернативные названия через запятую
- `tmdb_movie_id`, `tmdb_tv_id` — TMDB ID жанра для фильмов/сериалов
- `avg_rating` — средняя оценка пользователя по фильмам этого жанра
- `rating_count` — количество оценённых фильмов

### Director
Справочник режиссёров/создателей с персональными рейтингами:
- `id` — уникальный идентификатор
- `tmdb_id` — TMDB person ID
- `name` — имя режиссёра
- `avg_rating` — средняя оценка пользователя по фильмам режиссёра
- `rating_count` — количество оценённых фильмов

### Actor
Справочник актёров с персональными рейтингами:
- `id` — уникальный идентификатор
- `tmdb_id` — TMDB person ID
- `name` — имя актёра
- `avg_rating` — средняя оценка пользователя по фильмам с участием актёра
- `rating_count` — количество оценённых фильмов

### UserRating
Пользовательские оценки:
- `movie_id` — связь с фильмом (one-to-one)
- `rating` — оценка 1-10
- `review` — текст рецензии (опционально)
- `created_at`, `updated_at`

### Wishlist
Список желаемого к просмотру:
- `movie_id` — связь с фильмом
- `added_at` — дата добавления

### RecommendationCache
Кэш TMDB рекомендаций:
- `source_tmdb_id` — ID фильма-источника
- `source_is_tv` — тип источника
- `recommended_ids` — JSON список рекомендованных TMDB ID
- `updated_at` — дата последнего обновления

## Технологии

- **[Flet](https://flet.dev/)** — UI фреймворк (Material Design)
- **[SQLAlchemy](https://www.sqlalchemy.org/)** — ORM для SQLite (async)
- **[HTTPX](https://www.python-httpx.org/)** — асинхронный HTTP клиент
- **[TMDB API](https://developers.themoviedb.org/3)** — основной источник данных о фильмах и сериалах
- **[MDBList API](https://mdblist.com/)** — агрегатор рейтингов (IMDB, RT, Metacritic)
- **[OMDB API](https://www.omdbapi.com/)** — запасной источник рейтингов
- **[Kinopoisk API](https://kinopoiskapiunofficial.tech/)** — рейтинги Кинопоиска

## Сборка exe

```bash
# Установить PyInstaller (если не установлен)
pipenv run pip install pyinstaller

# Собрать exe
pipenv run flet pack main.py -n "MoviePicker" -i "Movie.ico" --product-name "Movie Picker" --product-version "1.0.0" --add-data "C:\Users\deade\.virtualenvs\movie_picker-5WF1bUEv\Lib\site-packages\flet\controls\material\icons.json;flet/controls/material" --hidden-import aiosqlite -y
```

Готовый файл будет в папке `dist/MoviePicker.exe` (~82 MB).

**Важно:** Для работы exe нужен файл `.env` с API ключами в той же папке, где лежит exe.

## Лицензия

MIT
